import CodeBlock from '@theme/CodeBlock';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import DebuggerAttachWebstorm from './partials/_debugging-attach-webstorm.mdx';
import DebuggerAttachChrome from './partials/_debugging-attach-chrome.mdx';
import DebuggerAttachVscode from './partials/_debugging-attach-vscode.mdx';
import CompilingIOS from './partials/_debugging-native-code-compliing-ios.mdx';
import CompilingAndroid from './partials/_debugging-native-code-compliing-android.mdx';
import ConfigIOS from './partials/_debugging-native-code-config-ios.mdx';
import ConfigAndroid from './partials/_debugging-native-code-config-android.mdx';
import RunIos from './partials/_debugging-native-code-run-ios.mdx';
import RunAndroid from './partials/_debugging-native-code-run-android.mdx';
import TroubleshootingAndroid from './partials/_debugging-native-code-troubleshooting-android.mdx';

# How to Debug

In the Detox world, you can debug either Detox itself (i.e. run it step by step), and the tested app. This guide covers both options.

## Running Detox Tests Step-by-Step

### Using Node.js Inspector

Detox tests can be run step-by-step either using an IDE or by using Chrome debugger.

Start by running Detox using the Detox CLI alongside the inspection argument (`--inspect-brk`) and the file in which the test resides. For example:

```bash
detox test --inspect-brk -c android.emu.debug e2e/starter.test.js
```

You will see Detox starts and these logs:

```plain text
Debugger listening on ws://127.0.0.1:9229/3dedd03b-8896-4ab8-a0a8-1b647abb9c98
For help, see: https://nodejs.org/en/docs/inspector
```

Now you can attach to Detox and tap-in into its execution process.

:::info

To learn more about debugging with `--inspect-brk`, refer to [Debugging â€” Getting Started](https://nodejs.org/en/docs/guides/debugging-getting-started/) on the official Node.js website.

:::

<Tabs groupId="debuggerAttach">
  <TabItem value="Webstorm" label="Webstorm" default>
    <DebuggerAttachWebstorm />
  </TabItem>
  <TabItem value="vs-code" label="vs-code">
    <DebuggerAttachVscode />
  </TabItem>
  <TabItem value="Chrome" label="Chrome">
    <DebuggerAttachChrome />
  </TabItem>
</Tabs>

### Using Detox REPL Mode

Detox provides a REPL (Read-Eval-Print Loop) mode that allows you to interactively debug your app during test execution. This feature is built on Node.js's built-in [`node:repl`][1] module and is particularly useful when you need to explore the app's state, try different commands, or debug test failures.

To use REPL mode, you can either:

* Add the `--repl` flag when running your tests:

  ```bash
  detox test --repl -c ios.sim.debug e2e/someSuite.test.js
  ```

  Call `detox.REPL()` directly in your test code to enter REPL mode at a specific point:

  ```js
  describe('My test suite', () => {
    it('should do something', async () => {
      await device.launchApp();
      // Test some functionality

      // Enter REPL mode to debug
      await detox.REPL();

      // Continue with the test after exiting REPL
    });
  });
  ```

* Use `--repl=auto` to automatically enter REPL mode when a test fails:

  ```bash
  detox test --repl=auto -c ios.sim.debug e2e/someSuite.test.js
  ```

When in REPL mode, you can:

- Execute any Detox commands interactively
- Use standard Node.js REPL commands like `.help`, `.break`, `.clear`, `.exit`, etc.
- Use the `.dumpxml` command to print the current view hierarchy
- Use the `.ai` command to execute natural language commands (e.g., `.ai Tap on login button`). Note that you have [Detox Pilot][2] configured before you start.
- Access all Detox globals like `device`, `element`, `by`, etc.

<details>

  <summary>ðŸ’¡ <b>Adding scope to REPL context</b></summary>

You can pass extra scope to the REPL context to make those properties available during your debugging session. This is especially useful for providing access to screen drivers, test data, or utility functions:

```js
// Create useful objects for debugging
const myScreenDriver = {
  login: async (username, password) => { /* ... */ },
  navigateToSettings: async () => { /* ... */ }
};

const testUser = {
  username: 'test@example.com',
  password: 'password123',
};

// Pass them to the REPL context
await detox.REPL({
  myScreenDriver,
  testUser,
  sleep: (ms) => new Promise(resolve => setTimeout(resolve, ms)),
});
```

In the REPL session, you can then access and use these objects:

```
detox> myScreenDriver.login(testUser.username, testUser.password)
// Executes the login function

detox> await sleep(1000)
// Waits for 1 second
```
</details>

To exit REPL mode, press Ctrl+C or type `.exit`.

## Debugging JavaScript application code

Use debug configurations of your app that rely on React Native Packager running on port 8081 (or another):

* `ios.sim.debug`
* `android.emu.debug`

For the rest of details, please refer to [React Native â€“ Debugging](https://reactnative.dev/docs/debugging).

## Debugging Native application code

### Setting Detox up as a compiling dependency

:::info Note

This step is optional. It is intended for investigating weird crashes or when contributing to Detox itself.

:::

<Tabs groupId="mobileOs">
  <TabItem value="iOS" label="iOS" default>
    <CompilingIOS />
  </TabItem>
  <TabItem value="Android" label="Android">
    <CompilingAndroid />
  </TabItem>
</Tabs>

### Add a "manual" configuration to your Detox config

<Tabs groupId="mobileOs">
  <TabItem value="iOS" label="iOS" default>
    <ConfigIOS />
  </TabItem>
  <TabItem value="Android" label="Android">
    <ConfigAndroid />
  </TabItem>
</Tabs>

While the `behavior` section is a **mandatory** thing to include, there are a few more optional
parameters to disable various side effects and make life easier when debugging:

```diff
 {
   â€¦
   "configurations": {
     "<your configuration>": {
       â€¦
       "behavior": {
         "launchApp": "manual"
       },
+      "session": {
+        "autoStart": true,
+        "debugSynchronization": 0,
+        "server": "ws://localhost:8099",
+        "sessionId": "test"
+      },
+      "testRunner": {
+        "args": {
+          "testTimeout": 999999
+        }
+      }
+      "artifacts": false
     },
   }
 }
```

- Using a preconfigured `session` with an auto-starting server removes the legwork of copying and
pasting values to the instrumentation runner launch arguments dialog every time before any launch
from the IDE. Otherwise, by default when the `session` object omitted, `server` and `sessionId`
are randomly generated for every new test session.

- The `debugSynchronization: 0` override matters only if you have a global `session` config
with `debugSynchronization` set to a positive integer value. Otherwise, it is not needed. The point
is to disable regular app polling requests during debugging, since that only can hinder the debugging.

- If you are using Jest as a test runner, you might want to prolong the test timeout via forwarding
`--testTimeout 999999` to it.

- Setting `artifacts: false` override also matters only if you have a global `artifacts` config.
The motivation is to disable irrelevant taxing activities on the device such as capturing logs
screenshots, videos and so on. If your investigation addresses a specific artifact plugin glitch
on the native side, then just disable all the non-relevant plugins. See
[Configuration > Artifacts](../config/artifacts.mdx) document for the reference.

### Run a specific test

Usually, you would want to focus on a specific test suite to save time, e.g.:

<Tabs groupId="mobileOs">
  <TabItem value="iOS" label="iOS">
    <CodeBlock language="sh">
      detox test -c ios.manual e2e/someSuite.test.js
    </CodeBlock>
  </TabItem>
  <TabItem value="Android" label="Android">
    <CodeBlock language="sh">
      detox test -c android.manual e2e/someSuite.test.js
    </CodeBlock>
  </TabItem>
</Tabs>

:::caution

Don't use multiple workers, e.g. `-w, --maxWorkers` for Jest, if you set `session.sessionId` to a constant value.

:::

Afterwards, you should see your test suite starting as usual until it reaches the app launch, where
Detox stops instead and prompts you to launch the app from the IDE:

<Tabs groupId="mobileOs">
  <TabItem value="iOS" label="iOS">
    <RunIos />
  </TabItem>
  <TabItem value="Android" label="Android">
    <RunAndroid />
  </TabItem>
</Tabs>

### Troubleshooting

<Tabs groupId="mobileOs">
  <TabItem value="iOS" label="iOS">
    <>There are no known issues at the moment. Check out <b>Android</b> tab if you need some.</>
  </TabItem>
  <TabItem value="Android" label="Android">
    <TroubleshootingAndroid />
  </TabItem>
</Tabs>

[1]: https://nodejs.org/api/repl.html
[2]: ../pilot/testing-with-pilot.md
