"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[4879],{465:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>d});var i=t(58168),o=(t(96540),t(15680));const r={},a="Dealing With Problems With Building the App & Detox",l={unversionedId:"troubleshooting/building-the-app",id:"troubleshooting/building-the-app",title:"Dealing With Problems With Building the App & Detox",description:"This page is about issues related to building the app, typically triggered when running detox build (and not detox test, for example).",source:"@site/../docs/troubleshooting/building-the-app.md",sourceDirName:"troubleshooting",slug:"/troubleshooting/building-the-app",permalink:"/Detox/docs/next/troubleshooting/building-the-app",draft:!1,editUrl:"https://github.com/wix/Detox/edit/master/docs/../docs/troubleshooting/building-the-app.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Pilot Best Practices",permalink:"/Detox/docs/next/pilot/best-practices"},next:{title:"Dealing With Problems With Running Tests",permalink:"/Detox/docs/next/troubleshooting/running-tests"}},s={},d=[{value:"Android",id:"android",level:2},{value:"Problem: AAPT - resource linking failure",id:"problem-aapt---resource-linking-failure",level:3},{value:"Problem: minSdkVersion mismatch",id:"problem-minsdkversion-mismatch",level:3},{value:"Problem: Kotlin <code>stdlib</code> version conflicts",id:"problem-kotlin-stdlib-version-conflicts",level:3},{value:"Resolving for a precompiled dependency (<code>.aar</code>)",id:"resolving-for-a-precompiled-dependency-aar",level:4},{value:"Resolving for a compiling subproject",id:"resolving-for-a-compiling-subproject",level:4},{value:"Problem: <code>Duplicate files copied in ...</code>",id:"problem-duplicate-files-copied-in-",level:3},{value:"Running Detox in a Rosetta environment",id:"running-detox-in-a-rosetta-environment",level:3}],p={toc:d},c="wrapper";function u({components:e,...n}){return(0,o.yg)(c,(0,i.A)({},p,n,{components:e,mdxType:"MDXLayout"}),(0,o.yg)("h1",{id:"dealing-with-problems-with-building-the-app--detox"},"Dealing With Problems With Building the App & Detox"),(0,o.yg)("p",null,"This page is about issues related to building the app, typically triggered when running ",(0,o.yg)("inlineCode",{parentName:"p"},"detox build")," (and not ",(0,o.yg)("inlineCode",{parentName:"p"},"detox test"),", for example)."),(0,o.yg)("h2",{id:"android"},"Android"),(0,o.yg)("h3",{id:"problem-aapt---resource-linking-failure"},"Problem: AAPT - resource linking failure"),(0,o.yg)("p",null,"For build errors involving AAPT resource linking failure, such as this one:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-plain",metastring:"text",text:!0},"Execution failed for task ':app:processReleaseAndroidTestResources'.\n> A failure occurred while executing com.android.build.gradle.internal.res.LinkApplicationAndroidResourcesTask$TaskAction\n   > Android resource linking failed\n     ERROR:: AAPT: error: resource style/Widget.AppCompat.TextView ...\n")),(0,o.yg)("p",null,"Ensure that the following line appears in your app build script in the ",(0,o.yg)("inlineCode",{parentName:"p"},"dependencies")," section:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-gradle",metastring:'title="android/app/build.gradle"',title:'"android/app/build.gradle"'},"dependencies {\n    // ...\n    implementation 'androidx.appcompat:appcompat:1.1.0' // (check what the latest version is!)\n}\n")),(0,o.yg)("h3",{id:"problem-minsdkversion-mismatch"},"Problem: minSdkVersion mismatch"),(0,o.yg)("p",null,"For Gradle errors involving ",(0,o.yg)("inlineCode",{parentName:"p"},"minSdkVersion")," mismatches resembling this one:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-text"},'uses-sdk:minSdkVersion 18 cannot be smaller than version 21 declared in library [com.facebook.react:react-native:0.64.3] /Users/janedoe/.gradle/caches/transforms-3/6a9cd4eeeb285f80b9e6f413ecd78d0d/transformed/jetified-react-native-0.64.3/AndroidManifest.xml as the library might be using APIs not available in 18\n        Suggestion: use a compatible library with a minSdk of at most 18,\n                or increase this project\'s minSdk version to at least 21,\n                or use tools:overrideLibrary="com.facebook.react" to force usage (may lead to runtime failures)\n')),(0,o.yg)("p",null,"Try applying the solution suggested in ",(0,o.yg)("a",{parentName:"p",href:"https://stackoverflow.com/questions/21032271/how-to-inject-android-configuration-to-each-subproject-with-gradle"},"this Stack-overflow")," post, namely adding this to your root-project's ",(0,o.yg)("inlineCode",{parentName:"p"},"build.gradle")," file (replace ",(0,o.yg)("inlineCode",{parentName:"p"},"21")," those matching your app's ",(0,o.yg)("inlineCode",{parentName:"p"},"build.gradle"),"):"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-gradle",metastring:'title="android/build.gradle"',title:'"android/build.gradle"'},"allprojects {\n    afterEvaluate {\n        if (it.hasProperty('android')){\n            android {\n                defaultConfig {\n                    minSdkVersion 21 // Replace '21' with whatever suites your case\n                }\n            }\n        }\n    }\n}\n")),(0,o.yg)("h3",{id:"problem-kotlin-stdlib-version-conflicts"},"Problem: Kotlin ",(0,o.yg)("inlineCode",{parentName:"h3"},"stdlib")," version conflicts"),(0,o.yg)("p",null,"The problems and resolutions here are different depending on whether you\u2019re using Detox as a precompiled dependency artifact (i.e. an ",(0,o.yg)("inlineCode",{parentName:"p"},".aar"),") - which is by far the common case, or compiling it yourself."),(0,o.yg)("h4",{id:"resolving-for-a-precompiled-dependency-aar"},"Resolving for a precompiled dependency (",(0,o.yg)("inlineCode",{parentName:"h4"},".aar"),")"),(0,o.yg)("p",null,"Of all ",(0,o.yg)("a",{parentName:"p",href:"https://kotlinlang.org/docs/reference/using-gradle.html#configuring-dependencies"},"Kotlin implementation flavors"),", Detox assumes the most recent one, namely ",(0,o.yg)("inlineCode",{parentName:"p"},"kotlin-stdlib-jdk8"),'. If your Android build fails due to conflicts with implementations coming from other dependencies or even your own app, consider adding an exclusion to either the "other" dependencies or detox itself, for example:'),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-diff"},"dependencies {\n-    androidTestImplementation('com.wix:detox:+')\n+    androidTestImplementation('com.wix:detox:+') {\n+        exclude group: 'org.jetbrains.kotlin', module: 'kotlin-stdlib-jdk8'\n+    }\n}\n")),(0,o.yg)("p",null,"Detox should work with ",(0,o.yg)("inlineCode",{parentName:"p"},"kotlin-stdlib-jdk7"),", as well."),(0,o.yg)("p",null,"A typical error output formed by ",(0,o.yg)("inlineCode",{parentName:"p"},"Gradle")," in this case is as provided, for example, in ",(0,o.yg)("a",{parentName:"p",href:"https://github.com/wix/Detox/issues/1380"},"#1380"),":"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-plain",metastring:"text",text:!0},"Could not determine the dependencies of task ':detox:compileDebugAidl'.\n> Could not resolve all task dependencies for configuration ':detox:debugCompileClasspath'.\n   > Could not resolve org.jetbrains.kotlin:kotlin-stdlib:1.3.0.\n     Required by:\n         project :detox\n      > Cannot find a version of 'org.jetbrains.kotlin:kotlin-stdlib' that satisfies the version constraints:\n           Dependency path 'OurApp:detox:unspecified' --\x3e 'com.squareup.okhttp3:okhttp:4.0.0-alpha01' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib:1.3.30'\n           Dependency path 'OurApp:detox:unspecified' --\x3e 'com.squareup.okio:okio:2.2.2' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib:1.2.60'\n           Dependency path 'OurApp:detox:unspecified' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.3.0' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib:1.3.0'\n           Dependency path 'OurApp:detox:unspecified' --\x3e 'com.facebook.react:react-native:0.59.5' --\x3e 'com.squareup.okhttp3:okhttp:4.0.0-alpha01' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib:1.3.30'\n           Dependency path 'OurApp:detox:unspecified' --\x3e 'com.facebook.react:react-native:0.59.5' --\x3e 'com.squareup.okio:okio:2.2.2' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib:1.2.60'\n           Dependency path 'OurApp:detox:unspecified' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.3.0' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.3.0' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib:1.3.0'\n           Constraint path 'OurApp:detox:unspecified' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib' strictly '1.3.0' because of the following reason: debugRuntimeClasspath uses version 1.3.0\n           Constraint path 'OurApp:detox:unspecified' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib' strictly '1.3.0' because of the following reason: debugRuntimeClasspath uses version 1.3.0\n\n   > Could not resolve org.jetbrains.kotlin:kotlin-stdlib-common:1.3.0.\n     Required by:\n         project :detox\n      > Cannot find a version of 'org.jetbrains.kotlin:kotlin-stdlib-common' that satisfies the version constraints:\n           Dependency path 'OurApp:detox:unspecified' --\x3e 'com.squareup.okhttp3:okhttp:4.0.0-alpha01' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib:1.3.30' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib-common:1.3.30'\n           Constraint path 'OurApp:detox:unspecified' --\x3e 'org.jetbrains.kotlin:kotlin-stdlib-common' strictly '1.3.0' because of the following reason: debugRuntimeClasspath uses version 1.3.0\n")),(0,o.yg)("p",null,"(i.e. the project indirectly depends on different versions of ",(0,o.yg)("inlineCode",{parentName:"p"},"kotlin-stdlib"),", such as ",(0,o.yg)("inlineCode",{parentName:"p"},"1.3.0"),", ",(0,o.yg)("inlineCode",{parentName:"p"},"1.3.30"),", ",(0,o.yg)("inlineCode",{parentName:"p"},"1.2.60"),")"),(0,o.yg)("h4",{id:"resolving-for-a-compiling-subproject"},"Resolving for a compiling subproject"),(0,o.yg)("p",null,"Detox requires the Kotlin standard-library as its own dependency. Due to the ",(0,o.yg)("a",{parentName:"p",href:"https://kotlinlang.org/docs/reference/using-gradle.html#configuring-dependencies"},"many flavors")," by which Kotlin has been released, multiple dependencies often create a conflict."),(0,o.yg)("p",null,"For that, Detox allows for the exact specification of the standard library to use using two Gradle globals: ",(0,o.yg)("inlineCode",{parentName:"p"},"detoxKotlinVersion")," and ",(0,o.yg)("inlineCode",{parentName:"p"},"detoxKotlinStdlib"),". You can define both in your root build script file:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-gradle",metastring:'title="android/build.gradle"',title:'"android/build.gradle"'},"buildscript {\n    // ...\n    ext.detoxKotlinVersion = '1.3.0' // Detox' default is 1.2.0\n    ext.detoxKotlinStdlib = 'kotlin-stdlib-jdk7' // Detox' default is kotlin-stdlib-jdk8\n}\n")),(0,o.yg)("h3",{id:"problem-duplicate-files-copied-in-"},"Problem: ",(0,o.yg)("inlineCode",{parentName:"h3"},"Duplicate files copied in ...")),(0,o.yg)("p",null,"If you get an error like this:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-plain",metastring:"text",text:!0},"Execution failed for task ':app:transformResourcesWithMergeJavaResForDebug'.\n> com.android.build.api.transform.TransformException: com.android.builder.packaging.DuplicateFileException: Duplicate files copied in APK META-INF/LICENSE\n")),(0,o.yg)("p",null,"You need to add this to the ",(0,o.yg)("inlineCode",{parentName:"p"},"android")," section of your app build script:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-gradle",metastring:'title="android/app/build.gradle"',title:'"android/app/build.gradle"'},"packagingOptions {\n    exclude 'META-INF/LICENSE'\n}\n")),(0,o.yg)("h3",{id:"running-detox-in-a-rosetta-environment"},"Running Detox in a Rosetta environment"),(0,o.yg)("p",null,"When working with dependencies that require running your iOS app in a Rosetta simulator, you may encounter issues with the ",(0,o.yg)("inlineCode",{parentName:"p"},"detox build")," command. These issues often relate to SwiftEmitModule or SwiftCompile errors. To resolve this, follow these steps:"),(0,o.yg)("ol",null,(0,o.yg)("li",{parentName:"ol"},"Modify your build command in the Detox configuration:")),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-json"},'"build": "xcodebuild -workspace ios/MyApp.xcworkspace -scheme MyApp -configuration Debug -sdk iphonesimulator -arch x86_64 -derivedDataPath ios/build"\n')),(0,o.yg)("ol",null,(0,o.yg)("li",{parentName:"ol"},"Run the following command in your terminal to ensure Xcode is properly selected:")),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-bash"},"sudo xcode-select --switch /Applications/Xcode.app\n")),(0,o.yg)("ol",null,(0,o.yg)("li",{parentName:"ol"},"Launch the iOS simulator in Rosetta mode:")),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-bash"},"arch -x86_64 /Applications/Xcode.app/Contents/Developer/Applications/Simulator.app/Contents/MacOS/Simulator\n")),(0,o.yg)("p",null,"After following these steps, the ",(0,o.yg)("inlineCode",{parentName:"p"},"detox build")," command should run without errors in your Rosetta environment."),(0,o.yg)("admonition",{type:"note"},(0,o.yg)("p",{parentName:"admonition"},"This approach configures Detox specifically to build and run with Rosetta without affecting your app's regular builds. To run your app with Rosetta in Xcode, enable Rosetta simulator destinations via Xcode.")))}u.isMDXComponent=!0},15680:(e,n,t)=>{t.d(n,{xA:()=>p,yg:()=>m});var i=t(96540);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,i)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach(function(n){o(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}function l(e,n){if(null==e)return{};var t,i,o=function(e,n){if(null==e)return{};var t,i,o={},r=Object.keys(e);for(i=0;i<r.length;i++)t=r[i],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)t=r[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=i.createContext({}),d=function(e){var n=i.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},p=function(e){var n=d(e.components);return i.createElement(s.Provider,{value:n},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},g=i.forwardRef(function(e,n){var t=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=d(t),g=o,m=c["".concat(s,".").concat(g)]||c[g]||u[g]||r;return t?i.createElement(m,a(a({ref:n},p),{},{components:t})):i.createElement(m,a({ref:n},p))});function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var r=t.length,a=new Array(r);a[0]=g;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[c]="string"==typeof e?e:o,a[1]=l;for(var d=2;d<r;d++)a[d]=t[d];return i.createElement.apply(null,a)}return i.createElement.apply(null,t)}g.displayName="MDXCreateElement"}}]);